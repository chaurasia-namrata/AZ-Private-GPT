<!DOCTYPE html>
<html class="h-full">
<head>
    <title>PrivateGPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ms: {
                            blue: '#0078D4',
                            teal: '#00B294',
                            gray: {
                                20: '#F3F2F1',
                                160: '#605E5C',
                                190: '#323130'
                            }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap');
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        .settings-panel {
            transition: all 0.3s ease;
            max-height: 0;
            opacity: 0;
            visibility: hidden;
            overflow: hidden;
            background: transparent;
            border-radius: 0.5rem;
            margin: 0;
            padding: 0;
        }
        .settings-panel.open {
            max-height: 500px;
            opacity: 1;
            visibility: visible;
            overflow-y: auto;
            padding: 1rem;
            margin-top: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 flex flex-col">
    <!-- Header with collapsible settings -->
    <header class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl text-gray-800 dark:text-white shadow-sm py-4 sticky top-0 z-10 border-b border-gray-200/50 dark:border-gray-700/50 w-full">
        <div class="w-full px-4">
            <div class="flex items-center justify-between h-8">
                <!-- Logo and Title -->
                <div class="flex items-center space-x-3">
                    <div class="flex items-center justify-center w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-teal-400">
                        <span class="text-white font-bold text-lg">I</span>
                    </div>
                    <h1 class="text-lg font-medium tracking-tight">PrivateGPT</h1>
                </div>

                <!-- Right section -->
                <div class="flex items-center space-x-2">

                    
                    <!-- User profile toggle -->
                    <div class="relative">
                        <button id="profile-toggle" 
                                class="inline-flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/70 transition-all duration-200 text-gray-700 dark:text-gray-200">
                            <span class="text-sm font-medium" id="user-name">{{ user.email }}</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        
                        <!-- User profile dropdown -->
                        <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                            <div class="p-4 border-b border-gray-200/50 dark:border-gray-700/50">
                                <p class="text-sm font-medium text-gray-800 dark:text-white" id="dropdown-user-name">{{ user.email }}</p>
                            </div>
                            <div class="p-2">
                                <button class="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700/70 rounded-lg transition-colors duration-200" onclick="logout()">Sign Out</button>
                            </div>
                        </div>
                    </div>
            </div>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar - Conversation history -->
        <aside class="w-72 flex-shrink-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg border-r border-gray-200/50 dark:border-gray-700/50">
            <!-- Search Results Panel -->
            <div id="search-results-panel" class="hidden fixed right-0 top-0 h-full w-80 bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl shadow-lg border-l border-gray-200/50 dark:border-gray-700/50 z-20">
                <div class="flex flex-col h-full">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200/50 dark:border-gray-700/50">
                        <h3 class="text-sm font-medium text-gray-800 dark:text-white">Search Results</h3>
                        <button id="close-search-panel" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/70 transition-colors duration-200">
                            <svg class="w-4 h-4 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div id="search-results-container" class="flex-1 overflow-y-auto p-4 space-y-3">
                        <!-- Search results will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            <div class="h-full flex flex-col p-6">
                <!-- Conversations Section -->
                <div class="flex-1 flex flex-col min-h-0">
                    <div class="flex items-center justify-between mb-4">
                        <button id="conversations-toggle" class="flex items-center space-x-2 group">
                            <h3 class="font-medium text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-white">Conversations</h3>
                            <svg id="conversations-chevron" class="w-5 h-5 text-gray-500 dark:text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <button id="new-chat" class="p-1.5 rounded-lg bg-ms-blue/10 hover:bg-ms-blue/20 text-ms-blue dark:text-ms-teal transition-colors duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                        </button>
                    </div>
                    <div id="conversations-container" class="flex-1 overflow-hidden transition-all duration-200 ease-in-out">
                        <div class="overflow-y-auto -mx-6 px-6">
                            <div id="conversation-list" class="space-y-2 pr-2 mb-4">
                                <!-- Conversations will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Model Settings Section -->
                <div class="pt-4 border-t border-gray-200/50 dark:border-gray-700/50">
                    <button id="settings-toggle" class="w-full flex items-center justify-between py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors duration-200">
                        <div class="flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span>Model Settings</span>
                        </div>
                        <svg class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="settings-chevron">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    
                    <!-- Settings Panel -->
                    <div id="settings-panel" class="settings-panel space-y-4 mt-2">
                        <!-- Model selection -->
                        <div class="space-y-2">
                            <label for="model" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Model</label>
                            <select id="model" class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-700 dark:text-gray-200 focus:outline-none focus:border-blue-500 dark:focus:border-teal-400">
                                {% for model in models %}
                                <option value="{{ model.id }}">{{ model.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Temperature control -->
                        <div class="space-y-2">
                            <label for="temperature" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Temperature</label>
                            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7"
                                   class="w-full accent-blue-500 dark:accent-teal-400">
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                <span>Precise</span>
                                <span>Creative</span>
                            </div>
                        </div>

                        <!-- Max length control -->
                        <div class="space-y-2">
                            <label for="max_tokens" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Max Tokens</label>
                            <input type="range" id="max_tokens" min="100" max="4000" step="100" value="2000"
                                   class="w-full accent-blue-500 dark:accent-teal-400">
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                <span>Short</span>
                                <span>Long</span>
                            </div>
                        </div>

                        <!-- Top P control -->
                        <div class="space-y-2">
                            <label for="top_p" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Top P</label>
                            <input type="range" id="top_p" min="0" max="1" step="0.1" value="0.9"
                                   class="w-full accent-blue-500 dark:accent-teal-400">
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                <span>Focused</span>
                                <span>Diverse</span>
                            </div>
                        </div>

                        <!-- Frequency Penalty -->
                        <div class="space-y-2">
                            <label for="frequency_penalty" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Frequency Penalty</label>
                            <input type="range" id="frequency_penalty" min="0" max="2" step="0.1" value="0"
                                   class="w-full accent-blue-500 dark:accent-teal-400">
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                <span>Allow Repetition</span>
                                <span>Avoid Repetition</span>
                            </div>
                        </div>

                        <!-- Presence Penalty -->
                        <div class="space-y-2">
                            <label for="presence_penalty" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Presence Penalty</label>
                            <input type="range" id="presence_penalty" min="0" max="2" step="0.1" value="0"
                                   class="w-full accent-blue-500 dark:accent-teal-400">
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                <span>Stay Focused</span>
                                <span>Explore Topics</span>
                            </div>
                        </div>

                        <!-- Stop Sequences -->
                        <div class="space-y-2">
                            <label for="stop" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Stop Sequences</label>
                            <input type="text" id="stop" value=""
                                   placeholder="Enter stop sequences separated by commas"
                                   class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-700 dark:text-gray-200 focus:outline-none focus:border-blue-500 dark:focus:border-teal-400">
                        </div>


                        <!-- Number of images -->
                        <div class="space-y-2">
                            <label for="n" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Number of Images</label>
                            <input type="number" id="n" min="1" max="4" value="1"
                                   class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-700 dark:text-gray-200 focus:outline-none focus:border-blue-500 dark:focus:border-teal-400">
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main content area -->
        <main class="flex-1 flex bg-white/40 dark:bg-gray-900/40">
            <!-- Search results panel -->
            <div id="search-results-panel" class="hidden w-80 border-r border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg overflow-y-auto">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100">Search Results</h3>
                        <button id="close-search-panel" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="search-results-container" class="space-y-4"></div>
                </div>
            </div>

            <!-- Chat area -->
            <div class="flex-1 flex flex-col">
                <div id="chat-history" class="flex-1 overflow-y-auto px-8 py-6 space-y-8 scroll-smooth relative">
                <!-- Welcome state for empty conversation -->
                <div id="welcome-state" class="absolute inset-0 flex flex-col items-center justify-center p-6 space-y-8">
                    <div class="text-center space-y-2">
                        <h2 class="text-2xl font-medium text-gray-800 dark:text-white">Welcome to PrivateGPT</h2>
                        <p class="text-gray-600 dark:text-gray-400">Your secure AI assistant with chat and image generation capabilities</p>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl w-full">
                        <button class="sample-prompt text-left p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-teal-400 bg-white/50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-all duration-200 group">
                            <div class="text-sm font-medium text-gray-800 dark:text-white mb-1">Investment Visual</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400 group-hover:text-blue-500 dark:group-hover:text-teal-400">/imagine A modern infographic showing the power of compound interest in mutual funds</div>
                        </button>
                        <button class="sample-prompt text-left p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-teal-400 bg-white/50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-all duration-200 group">
                            <div class="text-sm font-medium text-gray-800 dark:text-white mb-1">Portfolio Strategy</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400 group-hover:text-blue-500 dark:group-hover:text-teal-400">/imagine A clean visualization of asset allocation across equity, debt, and gold</div>
                        </button>
                        <button class="sample-prompt text-left p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-teal-400 bg-white/50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-all duration-200 group">
                            <div class="text-sm font-medium text-gray-800 dark:text-white mb-1">Investment Basics</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400 group-hover:text-blue-500 dark:group-hover:text-teal-400">What's the difference between mutual funds and ETFs for a beginner investor?</div>
                        </button>
                        <button class="sample-prompt text-left p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-teal-400 bg-white/50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-all duration-200 group">
                            <div class="text-sm font-medium text-gray-800 dark:text-white mb-1">Market Analysis</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400 group-hover:text-blue-500 dark:group-hover:text-teal-400">Explain how to analyze a company's financial health before investing</div>
                        </button>


                    
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-200/50 dark:border-gray-700/50 p-6 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg">
                <div class="relative max-w-3xl mx-auto">
                    <div class="flex items-center space-x-2">
                        <div class="flex-1 relative">
                            <textarea id="message" 
                                      class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl py-2.5 px-4 resize-none focus:outline-none focus:border-blue-500 dark:focus:border-teal-400 transition-all duration-200 text-gray-700 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500"
                                      placeholder="Message PrivateGPT..." 
                                      rows="1"
                                      style="min-height: 44px; max-height: 200px;"></textarea>
                            <div class="absolute right-3 bottom-2.5 flex items-center space-x-1">
                                <div class="relative flex items-center space-x-2">
                                    <!-- Web search toggle -->
                                    <button id="searchToggle" class="p-2 rounded-lg hover:bg-gray-100/50 dark:hover:bg-gray-800/50 transition-colors duration-200" title="Toggle web search">
                                        <span id="searchIcon" class="text-xl">üîç</span>
                                    </button>
                                    <input type="file" id="pdf-upload" accept=".pdf" class="hidden">
                                    <button type="button" id="pdf-upload-btn" onclick="document.getElementById('pdf-upload').click()" class="p-1.5 rounded-xl text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/70 transition-all duration-200" title="Upload PDF for context">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                    </button>
                                    <div id="pdf-status" class="absolute bottom-full right-0 mb-2 text-xs bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 rounded-lg shadow-lg p-2 min-w-[200px] hidden">
                                        <div class="flex items-center justify-between space-x-2">
                                            <span class="pdf-status-text"></span>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        <button id="send" 
                                class="flex-shrink-0 h-11 w-11 flex items-center justify-center rounded-xl bg-gradient-to-r from-blue-500 to-teal-400 text-white shadow-lg hover:shadow-xl hover:from-blue-600 hover:to-teal-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 active:scale-95">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                    <div class="mt-2 flex items-center justify-between px-1 text-xs text-gray-400 dark:text-gray-500">
                        <div>Use <kbd class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-800 rounded text-gray-500 dark:text-gray-400 font-mono">/imagine with prompt</kbd> to generate images</div>
                        <div>Press <kbd class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-800 rounded text-gray-500 dark:text-gray-400 font-mono">‚åò</kbd> + <kbd class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-800 rounded text-gray-500 dark:text-gray-400 font-mono">‚èé</kbd> for newline, <kbd class="px-1.5 py-0.5 bg-gray-100 dark:bg-gray-800 rounded text-gray-500 dark:text-gray-400 font-mono">‚èé</kbd> to send</div>
                    </div>
                </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Password Change Modal -->
    <div id="password-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-md w-full mx-4 overflow-hidden">
            <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Change Password</h3>
            </div>
            <form id="password-form" class="p-6 space-y-4">
                <div>
                    <label for="current-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Current Password</label>
                    <input type="password" id="current-password" name="current_password" required
                           class="w-full px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Password</label>
                    <input type="password" id="new-password" name="new_password" required
                           class="w-full px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hidePasswordModal()"
                            class="px-4 py-2 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/70 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-colors duration-200">
                        Update Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Password change modal functionality
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');

        function showPasswordModal() {
            passwordModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hidePasswordModal() {
            passwordModal.classList.add('hidden');
            document.body.style.overflow = '';
            passwordForm.reset();
        }

        // Handle password form submission
        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            try {
                const response = await fetch('/user/password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: formData.get('current_password'),
                        new_password: formData.get('new_password')
                    })
                });
                
                if (response.ok) {
                    alert('Password updated successfully');
                    hidePasswordModal();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to update password');
                }
            } catch (error) {
                console.error('Password update error:', error);
                alert('An error occurred while updating password');
            }
        });

        // Settings panel functionality
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsChevron = document.getElementById('settings-chevron');
        
        settingsToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsPanel.classList.toggle('open');
            settingsChevron.style.transform = settingsPanel.classList.contains('open') ? 'rotate(180deg)' : '';
        });

        // Prevent settings panel from closing when clicking inside it
        settingsPanel.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Close settings panel when clicking outside
        document.addEventListener('click', () => {
            settingsPanel.classList.remove('open');
            settingsChevron.style.transform = '';            
        });

        // User profile functionality
        const profileToggle = document.getElementById('profile-toggle');
        const profileDropdown = document.getElementById('profile-dropdown');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const dropdownUserName = document.getElementById('dropdown-user-name');
        const dropdownUserEmail = document.getElementById('dropdown-user-email');
        
        // Update user info function
        function updateUserInfo(name, email) {
            userName.textContent = name;
            userEmail.textContent = email;
            dropdownUserName.textContent = name;
            dropdownUserEmail.textContent = email;
        }
        
        // Toggle profile dropdown
        profileToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('hidden');
            if (settingsPanel.classList.contains('open')) {
                settingsPanel.classList.remove('open');
            }
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            profileDropdown.classList.add('hidden');
            settingsPanel.classList.remove('open');
        });
        
        // Prevent dropdown close when clicking inside
        profileDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // User actions
        function showChangePassword() {
            // TODO: Implement password change modal
            alert('Change password functionality will be implemented');
        }
        
        function showProfile() {
            // TODO: Implement profile settings modal
            alert('Profile settings functionality will be implemented');
        }
        
        async function logout() {
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('Failed to logout. Please try again.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('An error occurred during logout.');
            }
        }
        
        // Prevent clicks inside panel from closing it
        settingsPanel.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Auto-resize textarea
        const textarea = document.getElementById('message');
        textarea.addEventListener('input', () => {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
        });

        // Conversation Management
        let currentConversationId = null;
        const conversationList = document.getElementById('conversation-list');
        const newChatButton = document.getElementById('new-chat');

        // Load conversations on startup
        loadConversations();

        // Create new conversation
        newChatButton.addEventListener('click', async () => {
            const response = await fetch('/conversations', { method: 'POST' });
            const conversation = await response.json();
            currentConversationId = conversation.id;
            clearChat();
            loadConversations();
        });

        async function loadConversations() {
            const response = await fetch('/conversations');
            const conversations = await response.json();
            
            conversationList.innerHTML = '';
            conversations.forEach(conv => {
                const button = document.createElement('button');
                button.className = `group w-full text-left px-3 py-2 rounded-lg transition-colors duration-200 text-sm ${conv.id === currentConversationId 
                    ? 'bg-ms-blue/10 text-ms-blue dark:text-ms-teal' 
                    : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300'}`;
                
                const title = conv.title || 'New Conversation';
                button.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="truncate">${title}</span>
                        <button class="delete-conv hidden group-hover:block p-1.5 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400" data-id="${conv.id}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>`;
                
                button.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-conv')) {
                        e.stopPropagation();
                        deleteConversation(conv.id);
                    } else {
                        loadConversation(conv.id);
                    }
                });
                
                conversationList.appendChild(button);
            });

            // If no conversation is selected and we have conversations, select the first one
            if (!currentConversationId && conversations.length > 0) {
                loadConversation(conversations[0].id);
            }
            // If no conversations exist, create a new one
            else if (conversations.length === 0) {
                newChatButton.click();
            }
        }

        async function loadConversation(id) {
            const response = await fetch(`/conversations/${id}`);
            const conversation = await response.json();
            
            currentConversationId = id;
            clearChat();
            hideWelcomeState();
            
            // Load conversation history
            if (conversation.messages && conversation.messages.length > 0) {
                conversation.messages.forEach(msg => {
                    addMessage(msg.content, msg.role, msg.is_image);
                });
            } else {
                showWelcomeState();
            }
            
            // Update conversation list UI
            loadConversations();
        }

        async function deleteConversation(id) {
            await fetch(`/conversations/${id}`, { method: 'DELETE' });
            if (id === currentConversationId) {
                currentConversationId = null;
                clearChat();
            }
            loadConversations();
        }

        function clearChat() {
            const chatHistory = document.getElementById('chat-history');
            // Preserve the welcome-state div when clearing
            const welcomeState = document.getElementById('welcome-state');
            chatHistory.innerHTML = '';
            chatHistory.appendChild(welcomeState);
            textarea.value = '';
            showWelcomeState();
            textarea.style.height = 'auto';
        }

        function removeMessage(messageId) {
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                messageElement.remove();
            }
        }

        // Welcome state management
        function showWelcomeState() {
            const welcomeState = document.getElementById('welcome-state');
            if (!welcomeState) return;
            welcomeState.style.display = 'flex';
        }

        function hideWelcomeState() {
            const welcomeState = document.getElementById('welcome-state');
            if (!welcomeState) return;
            welcomeState.style.display = 'none';
        }

        // Toggle conversations section
        const conversationsToggle = document.getElementById('conversations-toggle');
        const conversationsContainer = document.getElementById('conversations-container');
        const conversationsChevron = document.getElementById('conversations-chevron');
        let isConversationsExpanded = true;

        function toggleConversations(e) {
            e.stopPropagation(); // Prevent event from bubbling to parent elements
            isConversationsExpanded = !isConversationsExpanded;
            if (isConversationsExpanded) {
                conversationsContainer.style.maxHeight = conversationsContainer.scrollHeight + 'px';
                conversationsChevron.classList.remove('rotate-180');
                // Store after transition to avoid height constraint
                setTimeout(() => {
                    conversationsContainer.style.maxHeight = '';
                }, 200);
            } else {
                // Set actual height before collapsing
                conversationsContainer.style.maxHeight = conversationsContainer.scrollHeight + 'px';
                setTimeout(() => {
                    conversationsContainer.style.maxHeight = '0px';
                }, 0);
                conversationsChevron.classList.add('rotate-180');
            }
        }

        conversationsToggle.addEventListener('click', toggleConversations);

        // Initialize welcome state
        document.addEventListener('DOMContentLoaded', () => {
            if (!currentConversationId) {
                showWelcomeState();
            }
            
            // Initialize search functionality
            const searchToggle = document.getElementById('searchToggle');
            const searchIcon = document.getElementById('searchIcon');
            
            searchToggle.addEventListener('click', function() {
                searchEnabled = !searchEnabled;
                if (searchEnabled) {
                    searchIcon.textContent = 'üåê';
                    searchIcon.classList.add('text-blue-500', 'dark:text-teal-400');
                } else {
                    searchIcon.textContent = 'üîç';
                    searchIcon.classList.remove('text-blue-500', 'dark:text-teal-400');
                }
            });


            // Function to display search results
            function displaySearchResults(results) {
                const container = document.getElementById('search-results-container');
                container.innerHTML = '';
                
                if (!results || results.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center">No search results found</p>';
                    return;
                }
                
                results.forEach(result => {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'p-3 bg-white dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200';
                    
                    const title = document.createElement('a');
                    title.href = result.url;
                    title.target = '_blank';
                    title.className = 'text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline block mb-1';
                    title.textContent = result.title;
                    
                    const snippet = document.createElement('p');
                    snippet.className = 'text-xs text-gray-600 dark:text-gray-300';
                    snippet.textContent = result.snippet;
                    
                    resultElement.appendChild(title);
                    resultElement.appendChild(snippet);
                    container.appendChild(resultElement);
                });
            }
        });

        // Initialize search state
        let searchEnabled = false;

        // Chat functionality
        document.getElementById('send').addEventListener('click', sendMessage);
        
        function sendMessage() {
            const message = textarea.value.trim();
            if (!message || !currentConversationId) return;

            // Check for /imagine command
            if (message.startsWith('/imagine ')) {
                const prompt = message.slice(9);
                // Add user message
                addMessage(message, 'user');
                
                // Clear input
                textarea.value = '';
                textarea.style.height = 'auto';
                
                // Show loading message
                const loadingId = Date.now();
                addMessage('üé® Generating your image...', 'assistant', false, loadingId);
                
                // Create new conversation if needed
                const createConversation = !currentConversationId ? 
                    fetch('/conversations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => response.json())
                        .then(conv => {
                            currentConversationId = conv.id;
                            loadConversations(); // Update sidebar immediately
                            return conv;
                        })
                    : Promise.resolve({ id: currentConversationId });
                
                // Generate image after ensuring conversation exists
                createConversation.then(() => fetch('/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        prompt,
                        conversation_id: currentConversationId
                    })
                }))
                .then(response => response.json())
                .then(data => {
                    // Remove loading message
                    removeMessage(loadingId);
                    
                    if (data.success) {
                        addMessage(data.image_url, 'assistant', true);
                        // Update conversation list to show new message
                        loadConversations();
                    } else {
                        addMessage('Error generating image: ' + data.error, 'assistant');
                    }
                })
                .catch(error => {
                    // Remove loading message
                    removeMessage(loadingId);
                    addMessage('Error generating image: ' + error.message, 'assistant');
                });
                return;
            }

            // Add user message to chat
            addMessage(message, 'user');
            
            // Clear input
            textarea.value = '';
            textarea.style.height = 'auto';
            
            // Get AI response
            getAIResponse(message);
        }

        // Handle sample prompts
        document.querySelectorAll('.sample-prompt').forEach(button => {
            button.addEventListener('click', () => {
                const prompt = button.querySelector('div:last-child').textContent;
                document.getElementById('message').value = prompt;
                sendMessage();
            });
        });

        function addMessage(content, sender, isImage = false, messageId = null, isPdfAttachment = false) {
            hideWelcomeState();
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-6`;
            if (messageId) {
                messageDiv.id = `message-${messageId}`;
            }
            
            const bubbleWrapper = document.createElement('div');
            bubbleWrapper.className = 'relative group max-w-3xl';
            
            const bubble = document.createElement('div');
            bubble.className = `w-full rounded-2xl px-6 py-4 shadow-lg ${sender === 'user' 
                ? 'bg-gradient-to-r from-ms-blue to-ms-blue/90 text-white' 
                : 'bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border border-gray-100 dark:border-gray-700'}`;
            
            if (sender === 'assistant') {
                if (content.startsWith('üé®')) {
                    // Loading animation for image generation
                    bubble.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <div class="text-base">${content}</div>
                            <div class="w-4 h-4 border-2 border-gray-600 dark:border-gray-300 border-t-transparent rounded-full animate-spin"></div>
                        </div>`;
                } else if (isImage) {
                    bubble.className += ' p-2';
                    const img = document.createElement('img');
                    img.src = content;
                    img.alt = 'Generated image';
                    img.className = 'rounded-lg max-w-lg w-full h-auto';
                    bubble.appendChild(img);

                    // Add download button for images
                    const downloadButton = document.createElement('a');
                    downloadButton.href = content;
                    downloadButton.download = 'generated-image.png';
                    downloadButton.className = 'absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-all duration-200 p-2 rounded-xl bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 shadow-lg hover:shadow-xl border border-gray-100 dark:border-gray-600';
                    downloadButton.innerHTML = `
                        <svg class="w-4 h-4 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>`;
                    bubbleWrapper.appendChild(downloadButton);
                } else {
                    bubble.innerHTML = marked.parse(content);
                    
                    // Add copy button for text messages
                    const copyButton = document.createElement('button');
                    copyButton.className = 'absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-all duration-200 p-2 rounded-xl bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 shadow-lg hover:shadow-xl border border-gray-100 dark:border-gray-600';
                    copyButton.innerHTML = `
                        <svg class="w-4 h-4 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2M8 8h12a2 2 0 012 2v8a2 2 0 01-2 2H8a2 2 0 01-2-2v-8a2 2 0 012-2z"/>
                    </svg>`;
                
                    copyButton.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(content);
                            const originalHTML = copyButton.innerHTML;
                            copyButton.innerHTML = `
                                <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>`;
                            setTimeout(() => {
                                copyButton.innerHTML = originalHTML;
                            }, 1500);
                        } catch (err) {
                            console.error('Failed to copy:', err);
                        }
                    });
                    bubbleWrapper.appendChild(copyButton);
                }
            } else if (isPdfAttachment) {
                const attachmentDiv = document.createElement('div');
                attachmentDiv.className = 'inline-flex items-center space-x-2 bg-gray-100 dark:bg-gray-800 rounded-lg px-3 py-2';
                attachmentDiv.innerHTML = `
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="text-sm text-gray-600 dark:text-gray-300">${content}</span>
                `;
                bubble.appendChild(attachmentDiv);
            } else {
                bubble.textContent = content;
            }
            
            bubbleWrapper.appendChild(bubble);
            messageDiv.appendChild(bubbleWrapper);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function getAIResponse(message) {
            if (!currentConversationId) return;

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'flex justify-start mb-4';
            loadingDiv.innerHTML = `
                <div class="max-w-3xl rounded-xl px-5 py-4 bg-white dark:bg-gray-800 shadow-lg border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 rounded-full bg-blue-500 dark:bg-teal-500 flex items-center justify-center">
                                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded w-32 animate-pulse"></div>
                            <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded w-24 animate-pulse"></div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('chat-history').appendChild(loadingDiv);

            const params = new URLSearchParams({
                message: message,
                conversation_id: currentConversationId,
                model: document.getElementById('model').value,
                temperature: document.getElementById('temperature').value,
                top_p: document.getElementById('top_p').value,
                frequency_penalty: document.getElementById('frequency_penalty').value,
                presence_penalty: document.getElementById('presence_penalty').value,
                max_tokens: document.getElementById('max_tokens').value,
                stop: document.getElementById('stop').value,
                n: document.getElementById('n').value,
                enable_search: searchEnabled
            });

            const eventSource = new EventSource(`/chat?${params}`);
            let currentResponse = '';
            let messageElement = null;

            // Handle image generation commands separately
            if (message.startsWith('/imagine')) {
                const imageEventSource = new EventSource(`/generate-image?${new URLSearchParams({
                    prompt: message.substring(8).trim(),
                    conversation_id: currentConversationId
                })}`);

                imageEventSource.onmessage = function(event) {
                    try {
                        if (event.data === '[DONE]') {
                            imageEventSource.close();
                            if (loadingDiv && loadingDiv.parentNode) {
                                loadingDiv.remove();
                            }
                            return;
                        }

                        const jsonStr = event.data.replace(/^data: /, '');
                        const data = JSON.parse(jsonStr);
                        console.log('Received image data:', data);

                        if (data.type === 'image' && data.success) {
                            // Show generated image
                            const imageMessage = document.createElement('div');
                            imageMessage.className = 'flex justify-start mb-4';
                            imageMessage.innerHTML = `
                                <div class="flex-1 max-w-3xl">
                                    <div class="rounded-2xl p-2 shadow-lg bg-white/80 dark:bg-gray-800/80 text-gray-800 dark:text-gray-200 border border-gray-100 dark:border-gray-700">
                                        <img src="${data.image_path}" alt="Generated image" class="rounded-lg max-w-lg w-full h-auto" />
                                    </div>
                                </div>`;
                            document.getElementById('chat-history').appendChild(imageMessage);
                        } else if (data.error) {
                            console.error('Image generation error:', data.error);
                        }
                    } catch (e) {
                        console.error('Error handling image event:', e);
                        console.log('Raw event data:', event.data);
                    }
                };

                imageEventSource.onerror = function(error) {
                    console.error('Image EventSource error:', error);
                    imageEventSource.close();
                    if (loadingDiv && loadingDiv.parentNode) {
                        loadingDiv.remove();
                    }
                };

                return;
            }

            // Configure marked options for better rendering
            marked.setOptions({
                gfm: true, // GitHub Flavored Markdown
                breaks: true, // Add <br> on single line breaks
                headerIds: true, // Add IDs to headers
                mangle: false, // Don't escape HTML
                pedantic: false, // Don't be too strict with markdown spec
                smartLists: true, // Use smarter list behavior
                smartypants: true, // Use smart punctuation
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) {}
                    }
                    return code;
                }
            });

            eventSource.onmessage = function(event) {
                if (event.data === '[DONE]') {
                    if (loadingDiv && loadingDiv.parentNode) {
                        loadingDiv.remove();
                    }
                    return;
                }

                let data;
                try {
                    // Extract the JSON data after 'data: '
                    const jsonStr = event.data.replace(/^data: /, '');
                    data = JSON.parse(jsonStr);
                    console.log('Received SSE data:', data);
                } catch (e) {
                    console.error('Error parsing SSE data:', e);
                    console.log('Raw SSE data:', event.data);
                    return;
                }
                if (data.type === 'image_prompt') {
                    console.log('Showing image prompt:', data.rewritten);
                    // Show rewritten prompt
                    const promptMessage = document.createElement('div');
                    promptMessage.className = 'flex justify-start mb-4';
                    promptMessage.innerHTML = `
                        <div class="flex-1 max-w-3xl">
                            <div class="rounded-2xl px-6 py-4 shadow-lg bg-white/80 dark:bg-gray-800/80 text-gray-800 dark:text-gray-200 border border-gray-100 dark:border-gray-700">
                                <div class="prose prose-sm md:prose-base lg:prose-lg dark:prose-invert max-w-none">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-sm text-purple-600 dark:text-purple-400">üé® Rewritten for better image generation:</span>
                                        <button class="copy-prompt-button p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="text-sm bg-gray-50 dark:bg-gray-900/50 p-3 rounded-lg">${data.rewritten}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('chat-history').appendChild(promptMessage);
                    
                    // Add copy functionality for the prompt
                    const copyButton = promptMessage.querySelector('.copy-prompt-button');
                    if (copyButton) {
                        copyButton.addEventListener('click', function() {
                            navigator.clipboard.writeText(data.rewritten).then(() => {
                                this.innerHTML = `
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                `;
                                setTimeout(() => {
                                    this.innerHTML = `
                                        <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                                        </svg>
                                    `;
                                }, 2000);
                            });
                        });
                    }
                } else if (data.type === 'search_results') {
                    // Add search results as a message
                    const searchMessage = document.createElement('div');
                    searchMessage.className = 'flex justify-start mb-4';
                    searchMessage.innerHTML = `
                        <div class="flex-1 max-w-3xl">
                            <div class="rounded-2xl px-6 py-4 shadow-lg bg-white/80 dark:bg-gray-800/80 text-gray-800 dark:text-gray-200 border border-gray-100 dark:border-gray-700">
                                <div class="prose prose-sm md:prose-base lg:prose-lg dark:prose-invert max-w-none">
                                    <details class="mb-2">
                                        <summary class="text-sm text-gray-500 dark:text-gray-400 cursor-pointer hover:text-gray-700 dark:hover:text-gray-200">
                                            üîç Web Search Results (${data.results.length})
                                        </summary>
                                        <div class="mt-2 space-y-3">
                                            ${data.results.map(result => `
                                                <div class="pl-4 border-l-2 border-gray-200 dark:border-gray-700">
                                                    <div class="font-medium">${result.title}</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-300">${result.snippet}</div>
                                                    <a href="${result.url}" target="_blank" class="text-xs text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300">${result.url}</a>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('chat-history').appendChild(searchMessage);
                } else if (data.title) {
                    // Update conversation list when title is generated
                    loadConversations();
                } else if (data.type === 'image') {
                    if (data.success && data.image_path) {
                        const imageMessage = document.createElement('div');
                        imageMessage.className = 'flex justify-start mb-4';
                        imageMessage.innerHTML = `
                            <div class="flex-1 max-w-3xl">
                                <div class="rounded-2xl p-2 shadow-lg bg-white/80 dark:bg-gray-800/80 text-gray-800 dark:text-gray-200 border border-gray-100 dark:border-gray-700">
                                    <img src="${data.image_path}" alt="Generated image" class="rounded-lg max-w-lg w-full h-auto" />
                                </div>
                            </div>
                        `;
                        document.getElementById('chat-history').appendChild(imageMessage);
                    } else {
                        console.error('Image generation failed:', data.error);
                    }
                } else if (data.type === 'response') {
                    if (currentResponse === '') {
                        // Remove loading animation and create message container
                        loadingDiv.remove();
                        messageElement = document.createElement('div');
                        messageElement.setAttribute('data-message-id', 'temp-message');
                        messageElement.className = 'flex justify-start mb-4';
                        messageElement.innerHTML = `
                            <div class="flex-1 max-w-3xl">
                                <div class="rounded-2xl px-6 py-4 shadow-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border border-gray-100 dark:border-gray-700">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="text-xs text-gray-500 dark:text-gray-400">AI Response</div>
                                        <button class="copy-button p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="prose prose-sm md:prose-base lg:prose-lg dark:prose-invert max-w-none
                                        prose-headings:font-semibold prose-headings:text-gray-800 dark:prose-headings:text-gray-200
                                        prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg
                                        prose-p:text-gray-600 dark:prose-p:text-gray-300
                                        prose-pre:bg-gray-100 dark:prose-pre:bg-gray-900
                                        prose-code:text-blue-600 dark:prose-code:text-blue-400
                                        prose-code:before:content-none prose-code:after:content-none
                                        prose-strong:text-gray-900 dark:prose-strong:text-white
                                        prose-a:text-blue-600 dark:prose-a:text-blue-400 hover:prose-a:text-blue-800 dark:hover:prose-a:text-blue-300
                                        prose-li:marker:text-gray-400 dark:prose-li:marker:text-gray-500"></div>
                                </div>
                            </div>
                        `;
                        document.getElementById('chat-history').appendChild(messageElement);
                        currentResponse = data.content;
                    } else {
                        currentResponse += data.content;
                    }
                    
                    // Add copy functionality
                    const copyButton = messageElement.querySelector('.copy-button');
                    if (copyButton) {
                        copyButton.addEventListener('click', function() {
                            const textToCopy = currentResponse;
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                // Change icon to checkmark temporarily
                                this.innerHTML = `
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                `;
                                setTimeout(() => {
                                    this.innerHTML = `
                                        <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                                        </svg>
                                    `;
                                }, 2000);
                            });
                        });
                    }
                    
                    // Update message content
                    const contentDiv = messageElement.querySelector('.prose');
                    if (contentDiv) {
                        contentDiv.innerHTML = marked.parse(currentResponse);
                        // Re-run syntax highlighting
                        messageElement.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                        
                        // Make follow-up questions clickable if they exist
                        const followupSection = Array.from(contentDiv.querySelectorAll('strong')).find(el => el.textContent === 'Follow-up Questions:');
                        if (followupSection) {
                            const questions = contentDiv.querySelectorAll('li');
                            questions.forEach(li => {
                                li.style.cursor = 'pointer';
                                li.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700', 'p-1', 'rounded', 'transition-colors', 'duration-200');
                                li.addEventListener('click', function() {
                                    const input = document.getElementById('message-input');
                                    input.value = this.textContent.trim();
                                    input.focus();
                                });
                            });
                        }
                    }
                }
                if (data.type === 'followup_questions' && Array.isArray(data.questions) && data.questions.length > 0) {
                    // Create a container for follow-up questions
                    const followupContainer = document.createElement('div');
                    followupContainer.className = 'flex flex-wrap gap-2 mt-4';
                    
                    // Add a label for follow-up questions
                    const label = document.createElement('div');
                    label.className = 'w-full text-sm text-gray-500 dark:text-gray-400 mb-2';
                    label.textContent = 'Follow-up questions:';
                    followupContainer.appendChild(label);
                    
                    // Add each follow-up question as a bubble
                    data.questions.forEach((question, index) => {
                        const bubble = document.createElement('button');
                        bubble.className = 'px-4 py-2 text-sm bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 hover:border-gray-300 dark:hover:border-gray-600 transition-all duration-200 cursor-pointer flex-grow-0';
                        bubble.title = question;  // Show full question on hover
                        bubble.textContent = question;
                        
                        bubble.addEventListener('click', async function() {
                            const question = this.textContent;
                            document.getElementById('message').value = question;
                            document.getElementById('message').focus();
                            // Add user message to chat
                            addMessage(question, 'user');
                            // Get AI response
                            await getAIResponse(question);
                        });
                        
                        followupContainer.appendChild(bubble);
                    });
                    
                    // Add the follow-up container after the message
                    if (messageElement && messageElement.querySelector('.flex-1')) {
                        messageElement.querySelector('.flex-1').appendChild(followupContainer);
                    }
                }
                if (data.error) {
                    console.error('Error:', data.error);
                    loadingDiv.remove();
                    eventSource.close();
                    addMessage('Error: ' + data.error, 'assistant');
                }
            };

            let hasError = false;
            
            eventSource.onerror = function(error) {
                if (hasError) return; // Prevent multiple error messages
                hasError = true;
                console.error('EventSource failed:', error);
                if (loadingDiv && loadingDiv.parentNode) {
                    loadingDiv.remove();
                }
                eventSource.close();
                // Only show error message if we haven't received any response yet
                if (!messageElement || currentResponse === '') {
                    addMessage('Error: Connection closed unexpectedly. Please try again.', 'assistant');
                }
            };
        }


        
        // Handle PDF upload
        const pdfUpload = document.getElementById('pdf-upload');
        const pdfStatus = document.getElementById('pdf-status');
        let statusTimeout;

        pdfUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('pdf', file);

            const statusText = pdfStatus.querySelector('.pdf-status-text');
            statusText.textContent = 'Uploading and processing PDF...';
            pdfStatus.classList.remove('hidden');
            pdfStatus.classList.remove('text-red-500');

            try {
                const response = await fetch('/upload-pdf', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    const statusText = pdfStatus.querySelector('.pdf-status-text');
                    statusText.textContent = `PDF uploaded successfully`;
                    updatePdfButtonState(true);
                    
                    // Add PDF attachment to chat
                    addMessage(`üìé Uploaded PDF: ${data.filename}`, 'user', false, null, true);

                    // Auto-hide status message after 2 seconds
                    clearTimeout(statusTimeout);
                    statusTimeout = setTimeout(() => {
                        pdfStatus.classList.add('hidden');
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Failed to process PDF');
                }
            } catch (error) {
                const statusText = pdfStatus.querySelector('.pdf-status-text');
                statusText.textContent = `Error: ${error.message}`;
                pdfStatus.classList.add('text-red-500');

                // Auto-hide error message after 2 seconds
                clearTimeout(statusTimeout);
                statusTimeout = setTimeout(() => {
                    pdfStatus.classList.add('hidden');
                }, 2000);
            }
        });

        const pdfUploadBtn = document.getElementById('pdf-upload-btn');

        function updatePdfButtonState(isUploaded) {
            if (isUploaded) {
                pdfUploadBtn.classList.remove('text-gray-400', 'hover:text-gray-600', 'dark:text-gray-500', 'dark:hover:text-gray-300');
                pdfUploadBtn.classList.add('text-red-500', 'hover:text-red-600', 'dark:text-red-400', 'dark:hover:text-red-300');
            } else {
                pdfUploadBtn.classList.remove('text-red-500', 'hover:text-red-600', 'dark:text-red-400', 'dark:hover:text-red-300');
                pdfUploadBtn.classList.add('text-gray-400', 'hover:text-gray-600', 'dark:text-gray-500', 'dark:hover:text-gray-300');
            }
        }



        // Handle keyboard shortcuts for the textarea
        textarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
